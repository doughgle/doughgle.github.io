<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.111.3"><link rel=icon href=/images/icon.jpg><title>Exploring OCI Registries: Chapter 2: Install a Public Helm Chart on a Private Kubernetes Cluster | Douglas Hellinger</title><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.douglashellinger.com/explainer/container-oci-registry/pull-a-public-helm-chart/2-private-cluster-private-registry-public-deployer-cover.drawio.svg"><meta name=twitter:title content="Exploring OCI Registries: Chapter 2: Install a Public Helm Chart on a Private Kubernetes Cluster"><meta name=twitter:description content="When you wanna install a public helm chart on a private kubernetes cluster…
See also How To Pull And Verify Any Public Helm Chart From An OCI Registry"><meta property="og:title" content="Exploring OCI Registries: Chapter 2: Install a Public Helm Chart on a Private Kubernetes Cluster"><meta property="og:description" content="When you wanna install a public helm chart on a private kubernetes cluster…
See also How To Pull And Verify Any Public Helm Chart From An OCI Registry"><meta property="og:type" content="article"><meta property="og:url" content="https://www.douglashellinger.com/explainer/container-oci-registry/pull-a-public-helm-chart/"><meta property="og:image" content="https://www.douglashellinger.com/explainer/container-oci-registry/pull-a-public-helm-chart/2-private-cluster-private-registry-public-deployer-cover.drawio.svg"><meta property="article:section" content="explainer"><meta property="article:published_time" content="2023-09-10T14:30:49+08:00"><meta property="article:modified_time" content="2023-07-22T22:22:49+08:00"><link href=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css rel=stylesheet integrity=sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.0.13/css/all.css integrity=sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp crossorigin=anonymous><link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel=stylesheet><link rel=stylesheet href=https://www.douglashellinger.com/css/medium.a3d5489836b19de22a81ddc6bd21c17547d07529e67b266427378a04fa3ea727.css integrity="sha256-o9VImDaxneIqgd3GvSHBdUfQdSnmeyZkJzeKBPo+pyc="><link rel=stylesheet href=https://www.douglashellinger.com/css/additional.8819b6defcdc6d21280f9b402b00df87ca779135901de6c22e708c62e20184b9.css integrity="sha256-iBm23vzcbSEoD5tAKwDfh8p3kTWQHebCLnCMYuIBhLk="></head><body><nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down"><div class="container pr-0"><a class=navbar-brand href=https://www.douglashellinger.com/><img src=/images/icon.jpg alt=logo></a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarMediumish aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarMediumish><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=/blog>Blog</a></li><li class=nav-item><a class=nav-link href=/explainer>Explainers</a></li><li class=nav-item><a class=nav-link href=/food>Food</a></li><li class=nav-item><a class=nav-link href=/how-to>How to Guides</a></li><li class=nav-item><a class=nav-link href=/>About</a></li></ul></div></div></nav><div class=site-content><div class=container><div class=mainheading><h1 class=sitetitle>Douglas Hellinger</h1><p class=lead>Helping you have fun and maximise impact by learning containers and kubernetes!</p></div><div class=main-content><div class=container><div class=row><div class="col-md-2 pl-0"><div class="share sticky-top sticky-top-offset"><p>Share</p><ul><li class="ml-1 mr-1"><a target=_blank href="https://twitter.com/intent/tweet?text=Exploring%20OCI%20Registries%3a%20Chapter%202%3a%20Install%20a%20Public%20Helm%20Chart%20on%20a%20Private%20Kubernetes%20Cluster&url=https%3a%2f%2fwww.douglashellinger.com%2fexplainer%2fcontainer-oci-registry%2fpull-a-public-helm-chart%2f" onclick='return window.open(this.href,"twitter-share","width=550,height=435"),!1'><i class="fab fa-twitter"></i></a></li><li class="ml-1 mr-1"><a target=_blank href="https://facebook.com/sharer.php?u=https%3a%2f%2fwww.douglashellinger.com%2fexplainer%2fcontainer-oci-registry%2fpull-a-public-helm-chart%2f" onclick='return window.open(this.href,"facebook-share","width=550,height=435"),!1'><i class="fab fa-facebook-f"></i></a></li><li class="ml-1 mr-1"><a target=_blank href="https://www.xing.com/spi/shares/new?url=https%3a%2f%2fwww.douglashellinger.com%2fexplainer%2fcontainer-oci-registry%2fpull-a-public-helm-chart%2f" onclick='return window.open(this.href,"xing-share","width=550,height=435"),!1'><i class="fab fa-xing"></i></a></li></ul><div class=sep></div><ul><li><a class="small smoothscroll" href=#disqus_thread></a></li></ul></div></div><div class="col-md-9 flex-first flex-md-unordered"><div class=mainheading><div class="row post-top-meta"><div class="col-xs-12 col-md-3 col-lg-2 text-center text-md-left mb-4 mb-md-0 md-nopad-right"><img class=author-thumb src=/images/profile.jpg alt="Douglas Hellinger"></div><div class="col-xs-12 col-md-9 col-lg-10 text-center text-md-left md-nopad-left"><a target=_blank class=link-dark>Douglas Hellinger</a><br><span class=author-description>Creator of this blog.<br><i class="far fa-star"></i>
Sep 10, 2023
<i class="far fa-clock clock"></i>
10 min read</span></div></div><h1 class=posttitle>Exploring OCI Registries: Chapter 2: Install a Public Helm Chart on a Private Kubernetes Cluster</h1></div><img class="featured-image img-fluid" src=https://www.douglashellinger.com/explainer/container-oci-registry/pull-a-public-helm-chart/2-private-cluster-private-registry-public-deployer-cover.drawio.svg alt="thumbnail for this post"><div class=article-post><p><strong>When you wanna install a <em>public</em> helm chart on a <em>private</em> kubernetes cluster…</strong></p><blockquote><p>See also <a href=../../../how-to/proxy-public-chart-repositories-as-oci-artefacts/>How To Pull And Verify Any Public Helm Chart From An OCI Registry</a></p></blockquote><p>Let’s continue the journey into OCI registries with another common use case:</p><h2 id=install-a-public-helm-chart>Install A Public Helm Chart</h2><p>Aisha picked the <a href=https://artifacthub.io/packages/helm/projectcalico/tigera-operator>Tigera Operator for Calico</a> Helm Chart.</p><p>Let&rsquo;s install it&mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>helm repo add projectcalico <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>https://docs.projectcalico.org/charts/
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl create namespace tigera-operator
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>helm install calico <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>projectcalico/tigera-operator <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--version 3.26.1 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--namespace tigera-operator
</span></span></code></pre></div><p>A moment later, the pod&rsquo;s reporting <code>ErrImagePull</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl get po -n tigera-operator
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>NAME                              READY   STATUS         RESTARTS   AGE
</span></span><span style=display:flex><span>tigera-operator-5f4668786-tzjkp   0/1     ErrImagePull   <span style=color:#ae81ff>0</span>          7s
</span></span></code></pre></div><h2 id=oh-yeah-forgot-route-to-the-internet-is-blocked>Oh Yeah, Forgot. Route To The Internet Is Blocked</h2><p><img src=./1-route-to-the-internet-is-blocked.drawio.svg alt="Architecture Diagram Showing Private Kubernetes Cluster" title="No Pulling Down In Public"></p><p>The <em>private</em> kubernetes cluster can&rsquo;t pull from the <em>public</em> internet.</p><p>But the private registry can. It operates as a pull-through cache for public images.</p><p><img src=./2-private-cluster-private-registry-public-deployer-cover.drawio.svg alt="Architecture Diagram Showing Kubernetes Cluster Pull From Private OCI Registry Proxy" title="Push And Pull: Like Docking a boat"></p><p>The cluster must pull images from the private registry.</p><h2 id=better-update-all-the-image-refs-to-pull-from-the-private-registry>Better Update All The Image Refs To Pull From The Private Registry</h2><p>The default values file reveals images from 2 different public registries: <code>quay.io</code> and <code>docker.io</code>.</p><p>Looks like <code>registry</code> can be overridden for the operator.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>tigeraOperator</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>image</span>: <span style=color:#ae81ff>tigera/operator</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v1.30.4</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>registry</span>: <span style=color:#ae81ff>quay.io</span>
</span></span></code></pre></div><p>For <code>calicoctl</code>, we prefix the registry in the <code>image</code> ref.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>calicoctl</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>image</span>: <span style=color:#ae81ff>docker.io/calico/ctl</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tag</span>: <span style=color:#ae81ff>v3.26.1</span>
</span></span></code></pre></div><p>Let&rsquo;s update the <code>registry</code> for <code>tigera/operator</code> so that it pulls from our private registry proxy: <code>k3d-quay-io-mirror:5000</code>.</p><p>Likewise, let&rsquo;s update the registry for <code>calicoctl</code> to pull from our other registry proxy, <code>k3d-docker-io-mirror:5000</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>tigeraOperator</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>image</span>: <span style=color:#ae81ff>tigera/operator</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v1.30.4</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>registry</span>: <span style=color:#ae81ff>k3d-quay-io-mirror:5000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>calicoctl</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>image</span>: <span style=color:#ae81ff>k3d-docker-io-mirror:5000/calico/ctl</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tag</span>: <span style=color:#ae81ff>v3.26.1</span>
</span></span></code></pre></div><p>There. That should fix it.</p><h3 id=upgrade-the-release-with-the-custom-values>Upgrade The Release With the Custom Values</h3><p>Upgrade helm release with a new revision, specifying the custom values file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>helm upgrade calico <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>projectcalico/tigera-operator <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--namespace tigera-operator <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--version v3.26.1 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--install <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--values tigera-operator-values.yaml <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--debug
</span></span></code></pre></div><p>Now the Operator pod is <code>Running</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl get po -n tigera-operator
</span></span><span style=display:flex><span>NAME                               READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>tigera-operator-85bc6fb7bf-58m2m   1/1     Running   <span style=color:#ae81ff>0</span>          26s
</span></span></code></pre></div><p>How about the calico pods?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl get po -n calico-system
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>NAME                                       READY   STATUS                  RESTARTS   AGE
</span></span><span style=display:flex><span>calico-typha-bfc4ccd59-cmgsf               0/1     ImagePullBackOff        <span style=color:#ae81ff>0</span>          23s
</span></span><span style=display:flex><span>calico-kube-controllers-67b48b6f9c-5pgp9   0/1     ImagePullBackOff        <span style=color:#ae81ff>0</span>          23s
</span></span><span style=display:flex><span>calico-node-9g7mg                          0/1     Init:ImagePullBackOff   <span style=color:#ae81ff>0</span>          23s
</span></span><span style=display:flex><span>csi-node-driver-h2tnp                      0/2     ImagePullBackOff        <span style=color:#ae81ff>0</span>          23s
</span></span></code></pre></div><p>Ah. <code>ImagePullBackOff</code>.</p><p>There&rsquo;s at least 5* containers here that weren&rsquo;t visible in the default values file.</p><blockquote><p>* (<code>calico-node-9g7mg</code> is a Init Container, stuck at pull. Once it completes, there may be more.)</p></blockquote><p>Examining the events, we can see Containerd failed to send to a HEAD request to <code>registry-1.docker.io</code>, preventing pull of all container images.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl get events -n calico-system
</span></span><span style=display:flex><span>LAST SEEN   TYPE      REASON              OBJECT                                          MESSAGE
</span></span><span style=display:flex><span>51s         Warning   Failed              pod/csi-node-driver-h5wcv                       Error: ErrImagePull
</span></span><span style=display:flex><span>40s         Normal    BackOff             pod/csi-node-driver-h5wcv                       Back-off pulling image <span style=color:#e6db74>&#34;docker.io/calico/csi:v3.26.1&#34;</span>
</span></span><span style=display:flex><span>40s         Warning   Failed              pod/csi-node-driver-h5wcv                       Error: ImagePullBackOff
</span></span><span style=display:flex><span>40s         Normal    BackOff             pod/csi-node-driver-h5wcv                       Back-off pulling image <span style=color:#e6db74>&#34;docker.io/calico/node-driver-registrar:v3.26.1&#34;</span>
</span></span><span style=display:flex><span>40s         Warning   Failed              pod/csi-node-driver-h5wcv                       Error: ImagePullBackOff
</span></span><span style=display:flex><span>36s         Normal    Pulling             pod/calico-kube-controllers-6488ff9f7b-2psct    Pulling image <span style=color:#e6db74>&#34;docker.io/calico/kube-controllers:v3.26.1&#34;</span>
</span></span><span style=display:flex><span>35s         Normal    Pulling             pod/calico-node-v9ms2                           Pulling image <span style=color:#e6db74>&#34;docker.io/calico/pod2daemon-flexvol:v3.26.1&#34;</span>
</span></span><span style=display:flex><span>32s         Normal    Pulling             pod/calico-typha-6db4d666b5-9ggp7               Pulling image <span style=color:#e6db74>&#34;docker.io/calico/typha:v3.26.1&#34;</span>
</span></span><span style=display:flex><span>31s         Warning   Failed              pod/calico-typha-6db4d666b5-9ggp7               Failed to pull image <span style=color:#e6db74>&#34;docker.io/calico/typha:v3.26.1&#34;</span>: rpc error: code <span style=color:#f92672>=</span> Unknown desc <span style=color:#f92672>=</span> failed to pull and unpack image <span style=color:#e6db74>&#34;docker.io/calico/typha:v3.26.1&#34;</span>: failed to resolve reference <span style=color:#e6db74>&#34;docker.io/calico/typha:v3.26.1&#34;</span>: failed to <span style=color:#66d9ef>do</span> request: Head <span style=color:#e6db74>&#34;https://registry-1.docker.io/v2/calico/typha/manifests/v3.26.1&#34;</span>: dial tcp: lookup registry-1.docker.io: Try again
</span></span><span style=display:flex><span>31s         Warning   Failed              pod/calico-typha-6db4d666b5-9ggp7               Error: ErrImagePull
</span></span><span style=display:flex><span>31s         Warning   Failed              pod/calico-kube-controllers-6488ff9f7b-2psct    Failed to pull image <span style=color:#e6db74>&#34;docker.io/calico/kube-controllers:v3.26.1&#34;</span>: rpc error: code <span style=color:#f92672>=</span> Unknown desc <span style=color:#f92672>=</span> failed to pull and unpack image <span style=color:#e6db74>&#34;docker.io/calico/kube-controllers:v3.26.1&#34;</span>: failed to resolve reference <span style=color:#e6db74>&#34;docker.io/calico/kube-controllers:v3.26.1&#34;</span>: failed to <span style=color:#66d9ef>do</span> request: Head <span style=color:#e6db74>&#34;https://registry-1.docker.io/v2/calico/kube-controllers/manifests/v3.26.1&#34;</span>: dial tcp: lookup registry-1.docker.io: Try again
</span></span><span style=display:flex><span>31s         Warning   Failed              pod/calico-kube-controllers-6488ff9f7b-2psct    Error: ErrImagePull
</span></span><span style=display:flex><span>31s         Warning   Failed              pod/calico-node-v9ms2                           Failed to pull image <span style=color:#e6db74>&#34;docker.io/calico/pod2daemon-flexvol:v3.26.1&#34;</span>: rpc error: code <span style=color:#f92672>=</span> Unknown desc <span style=color:#f92672>=</span> failed to pull and unpack image <span style=color:#e6db74>&#34;docker.io/calico/pod2daemon-flexvol:v3.26.1&#34;</span>: failed to resolve reference <span style=color:#e6db74>&#34;docker.io/calico/pod2daemon-flexvol:v3.26.1&#34;</span>: failed to <span style=color:#66d9ef>do</span> request: Head <span style=color:#e6db74>&#34;https://registry-1.docker.io/v2/calico/pod2daemon-flexvol/manifests/v3.26.1&#34;</span>: dial tcp: lookup registry-1.docker.io: Try again
</span></span><span style=display:flex><span>31s         Warning   Failed              pod/calico-node-v9ms2                           Error: ErrImagePull
</span></span><span style=display:flex><span>27s         Normal    Pulling             pod/csi-node-driver-h5wcv                       Pulling image <span style=color:#e6db74>&#34;docker.io/calico/csi:v3.26.1&#34;</span>
</span></span><span style=display:flex><span>22s         Warning   Failed              pod/csi-node-driver-h5wcv                       Failed to pull image <span style=color:#e6db74>&#34;docker.io/calico/csi:v3.26.1&#34;</span>: rpc error: code <span style=color:#f92672>=</span> Unknown desc <span style=color:#f92672>=</span> failed to pull and unpack image <span style=color:#e6db74>&#34;docker.io/calico/csi:v3.26.1&#34;</span>: failed to resolve reference <span style=color:#e6db74>&#34;docker.io/calico/csi:v3.26.1&#34;</span>: failed to <span style=color:#66d9ef>do</span> request: Head <span style=color:#e6db74>&#34;https://registry-1.docker.io/v2/calico/csi/manifests/v3.26.1&#34;</span>: dial tcp: lookup registry-1.docker.io: Try again
</span></span><span style=display:flex><span>22s         Warning   Failed              pod/csi-node-driver-h5wcv                       Error: ErrImagePull
</span></span><span style=display:flex><span>22s         Normal    Pulling             pod/csi-node-driver-h5wcv                       Pulling image <span style=color:#e6db74>&#34;docker.io/calico/node-driver-registrar:v3.26.1&#34;</span>
</span></span><span style=display:flex><span>17s         Warning   Failed              pod/csi-node-driver-h5wcv                       Failed to pull image <span style=color:#e6db74>&#34;docker.io/calico/node-driver-registrar:v3.26.1&#34;</span>: rpc error: code <span style=color:#f92672>=</span> Unknown desc <span style=color:#f92672>=</span> failed to pull and unpack image <span style=color:#e6db74>&#34;docker.io/calico/node-driver-registrar:v3.26.1&#34;</span>: failed to resolve reference <span style=color:#e6db74>&#34;docker.io/calico/node-driver-registrar:v3.26.1&#34;</span>: failed to <span style=color:#66d9ef>do</span> request: Head <span style=color:#e6db74>&#34;https://registry-1.docker.io/v2/calico/node-driver-registrar/manifests/v3.26.1&#34;</span>: dial tcp: lookup registry-1.docker.io: Try again
</span></span><span style=display:flex><span>9s          Normal    BackOff             pod/calico-typha-6db4d666b5-9ggp7               Back-off pulling image <span style=color:#e6db74>&#34;docker.io/calico/typha:v3.26.1&#34;</span>
</span></span><span style=display:flex><span>9s          Warning   Failed              pod/calico-typha-6db4d666b5-9ggp7               Error: ImagePullBackOff
</span></span><span style=display:flex><span>4s          Normal    BackOff             pod/calico-node-v9ms2                           Back-off pulling image <span style=color:#e6db74>&#34;docker.io/calico/pod2daemon-flexvol:v3.26.1&#34;</span>
</span></span><span style=display:flex><span>4s          Warning   Failed              pod/calico-node-v9ms2                           Error: ImagePullBackOff
</span></span><span style=display:flex><span>2s          Normal    BackOff             pod/calico-kube-controllers-6488ff9f7b-2psct    Back-off pulling image <span style=color:#e6db74>&#34;docker.io/calico/kube-controllers:v3.26.1&#34;</span>
</span></span><span style=display:flex><span>2s          Warning   Failed              pod/calico-kube-controllers-6488ff9f7b-2psct    Error: ImagePullBackOff
</span></span></code></pre></div><p>No need to analyse further. We know there&rsquo;s no route to the public internet from the cluster.</p><p>Tigera Operator creates pods that pull images from DockerHub. Dockerhub is blocked.</p><p>We wanna pull images from our private registry. How can we do that? 🤔</p><h3 id=update-all-images-used-by-subcharts>Update All Images Used By Subcharts</h3><p>Are those images specified in the values of subcharts?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>helm inspect chart projectcalico/tigera-operator
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>appVersion</span>: <span style=color:#ae81ff>v3.26.1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>description</span>: <span style=color:#ae81ff>Installs the Tigera operator for Calico</span>
</span></span><span style=display:flex><span><span style=color:#f92672>home</span>: <span style=color:#ae81ff>https://projectcalico.docs.tigera.io/about/about-calico</span>
</span></span><span style=display:flex><span><span style=color:#f92672>icon</span>: <span style=color:#ae81ff>https://projectcalico.docs.tigera.io/images/felix_icon.png</span>
</span></span><span style=display:flex><span><span style=color:#f92672>name</span>: <span style=color:#ae81ff>tigera-operator</span>
</span></span><span style=display:flex><span><span style=color:#f92672>sources</span>:
</span></span><span style=display:flex><span>- <span style=color:#ae81ff>https://github.com/projectcalico/calico/tree/master/calico/_includes/charts/tigera-operator</span>
</span></span><span style=display:flex><span>- <span style=color:#ae81ff>https://github.com/tigera/operator</span>
</span></span><span style=display:flex><span>- <span style=color:#ae81ff>https://github.com/projectcalico/calico</span>
</span></span><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#ae81ff>v3.26.1</span>
</span></span></code></pre></div><p>Nope. No subcharts defined here.</p><h2 id=oh-wait-there-are-still-some-images-as-part-of-crd-update-them-too>Oh Wait, There Are Still Some Images As Part Of CRD, Update Them Too</h2><h3 id=override-the-registry-in-the-installation-crd>Override The Registry In The Installation CRD</h3><p>Turns out the answer is in the <a href=https://docs.tigera.io/calico/latest/reference/installation/api#operator.tigera.io/v1.InstallationSpec>Installation CRD Specification</a> as hinted in the comment of the default values.</p><p><img src=./4-installation-crd-spec.drawio.svg alt="Screenshot Showing Calico Installation CRD Specification" title="Specify the installation spec at install-time 🤨"></p><p>Let&rsquo;s override the <code>registry</code> value for the default Installation and try it</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>installation</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>kubernetesProvider</span>: <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>registry</span>: <span style=color:#ae81ff>k3d-docker-io-mirror:5000</span>
</span></span></code></pre></div><p>After a minute or two, the Calico pods are <code>Running</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl get po -n calico-system 
</span></span><span style=display:flex><span>NAME                                      READY   STATUS                 RESTARTS   AGE
</span></span><span style=display:flex><span>calico-typha-59d8dcf55d-jlz9p             1/1     Running                <span style=color:#ae81ff>0</span>          2m43s
</span></span><span style=display:flex><span>calico-kube-controllers-d6b96cb6d-pntdg   1/1     Running                <span style=color:#ae81ff>0</span>          2m41s
</span></span><span style=display:flex><span>calico-node-stzgr                         0/1     Running                <span style=color:#ae81ff>0</span>          2m41s
</span></span><span style=display:flex><span>csi-node-driver-5cvj8                     1/2     CreateContainerError   <span style=color:#ae81ff>0</span>          2m42s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get po -n calico-apiserver 
</span></span><span style=display:flex><span>NAME                                READY   STATUS    RESTARTS        AGE
</span></span><span style=display:flex><span>calico-apiserver-75fb78b976-xhszq   1/1     Running   <span style=color:#ae81ff>10</span> <span style=color:#f92672>(</span>123m ago<span style=color:#f92672>)</span>   2m41s
</span></span><span style=display:flex><span>calico-apiserver-75fb78b976-chsfj   1/1     Running   <span style=color:#ae81ff>10</span> <span style=color:#f92672>(</span>123m ago<span style=color:#f92672>)</span>   2m41s
</span></span></code></pre></div><hr><h2 id=problem-statement-devs-need-to-identify--override-image-registries>Problem Statement: Devs Need To Identify & Override Image Registries</h2><p>For every public Helm Chart, devs need to update all the image refs to point to our private registry.</p><p>That&rsquo;s not standardised across Helm Charts and Kubernetes Operators.</p><p>Each chart may do it differently. If there are Custom Resource Definitions, there are <em>custom</em> ways to specify image registries.</p><p>It can take a tedious number tries to deploy and update image refs until a public chart works.</p><p>What alternatives do we have? Is there a better way?</p><h2 id=some-possible-solutions>Some Possible Solutions</h2><ol><li>Override the registry in the chart values.</li><li>Use a <a href=https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#mutatingadmissionwebhook>Mutating Admission Webhook</a> to re-write the registry. For example, this <a href=https://release-1-9-0.kyverno.io/policies/other/replace_image_registry/replace_image_registry/>Kyverno Replace Image Registry ClusterPolicy</a>.</li><li>Configure the private registry as a <strong>Registry Mirror</strong> in the container runtime.</li></ol><p><img src=./3-solution-layers.drawio.svg alt="Layer Diagram Showing OCI, Kubernetes and Helm Layers" title="Bake first layers first like a Kueh Lapis"></p><p>When building a platform, we should ask ourselves &ldquo;Can we solve this at a layer below?&rdquo;</p><p>We&rsquo;re learning about OCI registries, so let&rsquo;s explore the OCI Registry and Runtime layer&mldr;</p><h2 id=configure-the-container-runtime-to-use-a-registry-mirror>Configure The Container Runtime To Use A Registry Mirror</h2><ol><li>In Containerd, we can <a href=https://github.com/containerd/containerd/blob/9b4ed8acc2a04a3f8df140e79052d18b750d757e/docs/hosts.md#setup-a-local-mirror-for-docker>Configure An OCI-Compliant Registry Mirror</a> in <code>/etc/containerd/certs.d/docker.io/hosts.toml</code>.</li></ol><blockquote><p>If you&rsquo;re using <a href=https://docs.aws.amazon.com/eks/latest/userguide/kubernetes-versions.html#kubernetes-1.27>EKS 1.27</a>, you&rsquo;re using Containerd. There&rsquo;s no alternative CRI.</p></blockquote><ol><li>In k3d, we can configure Containerd to use a Resgitry Mirror by configuring <code>registries.yaml</code> in the cluster spec:</li></ol><p><code>k3d-dev-private-use-registry-mirror.yaml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>k3d.io/v1alpha5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Simple</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>dev-private</span>
</span></span><span style=display:flex><span><span style=color:#f92672>servers</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>agents</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>options</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>k3d</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>disableLoadbalancer</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#f92672>registries</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>use</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>k3d-quay-io-mirror:5000</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>config</span>: <span style=color:#ae81ff>|</span> <span style=color:#75715e># define contents of the `registries.yaml` file (or reference a file); same as `--registry-config /path/to/config.yaml`</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>mirrors</span>:
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;quay.io&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>endpoint</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>http://k3d-quay-io-mirror:5000</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>k3d cluster create <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --config k3d-dev-private-use-registry-mirror.yaml <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --volume <span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span>/containerd.config.toml.tmpl:/var/lib/rancher/k3s/agent/etc/containerd/config.toml.tmpl
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0000<span style=color:#f92672>]</span> Using config file k3d-dev-private-use-registry-mirror.yaml <span style=color:#f92672>(</span>k3d.io/v1alpha5#simple<span style=color:#f92672>)</span> 
</span></span><span style=display:flex><span>WARN<span style=color:#f92672>[</span>0000<span style=color:#f92672>]</span> No node filter specified                     
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0000<span style=color:#f92672>]</span> Prep: Network                                
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0000<span style=color:#f92672>]</span> Created network <span style=color:#e6db74>&#39;k3d-use-reg-mirror&#39;</span>         
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0000<span style=color:#f92672>]</span> Created image volume k3d-use-reg-mirror-images 
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0000<span style=color:#f92672>]</span> Starting new tools node...                   
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0000<span style=color:#f92672>]</span> Starting Node <span style=color:#e6db74>&#39;k3d-use-reg-mirror-tools&#39;</span>     
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0001<span style=color:#f92672>]</span> Creating node <span style=color:#e6db74>&#39;k3d-use-reg-mirror-server-0&#39;</span>  
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0001<span style=color:#f92672>]</span> Using the k3d-tools node to gather environment information 
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0001<span style=color:#f92672>]</span> HostIP: using network gateway 172.22.0.1 address 
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0001<span style=color:#f92672>]</span> Starting cluster <span style=color:#e6db74>&#39;use-reg-mirror&#39;</span>            
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0001<span style=color:#f92672>]</span> Starting servers...                          
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0001<span style=color:#f92672>]</span> Starting Node <span style=color:#e6db74>&#39;k3d-use-reg-mirror-server-0&#39;</span>  
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0004<span style=color:#f92672>]</span> All agents already running.                  
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0004<span style=color:#f92672>]</span> All helpers already running.                 
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0004<span style=color:#f92672>]</span> Injecting records <span style=color:#66d9ef>for</span> hostAliases <span style=color:#f92672>(</span>incl. host.k3d.internal<span style=color:#f92672>)</span> and <span style=color:#66d9ef>for</span> <span style=color:#ae81ff>2</span> network members into CoreDNS configmap... 
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0007<span style=color:#f92672>]</span> Cluster <span style=color:#e6db74>&#39;use-reg-mirror&#39;</span> created successfully! 
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0007<span style=color:#f92672>]</span> You can now use it like this:                
</span></span><span style=display:flex><span>kubectl cluster-info
</span></span></code></pre></div><p>To test it, let&rsquo;s create a simple pod. We&rsquo;ll specify the tag, but omit the registry and repository.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl run nginx <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --image<span style=color:#f92672>=</span>nginx:stable
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>pod/nginx created
</span></span></code></pre></div><p>Describe the pod:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl describe pod nginx
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>Containers</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>nginx</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Container ID</span>:   <span style=color:#ae81ff>containerd://a6f171d5af552b144cec25504f4fb661015509185d0c064568b23ee55a04cfaf</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Image</span>:          <span style=color:#ae81ff>nginx:stable</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Image ID</span>:       <span style=color:#ae81ff>docker.io/library/nginx@sha256:a8281ce42034b078dc7d88a5bfe6d25d75956aad9abba75150798b90fa3d1010</span>
</span></span></code></pre></div><p>We can see the <code>Image ID</code> normalises the given image ref. In particular, it prefixes with the default registry <code>docker.io</code> and default repository <code>library</code>.</p><h3 id=kubernetes-logs-the-image-source-as-dockerhub-but-what-happened-at-the-container-runtime-layer>Kubernetes Logs The Image Source As Dockerhub, But What Happened At The Container Runtime Layer?</h3><p>Analyse the Containerd logs to find the request:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>docker cp k3d-dev-private-server-0:/var/lib/rancher/k3s/agent/containerd/containerd.log - | less
</span></span></code></pre></div><p>Use <code>/</code> to search for the pattern <code>nginx</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;info&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;PullImage \&#34;nginx:stable\&#34;&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-07-02T04:08:17.771504540Z&#34;</span>}
</span></span><span style=display:flex><span>{<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;debug&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;PullImage using normalized image ref: \&#34;docker.io/library/nginx:stable\&#34;&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-07-02T04:08:17.771521636Z&#34;</span>}
</span></span><span style=display:flex><span>{<span style=color:#f92672>&#34;host&#34;</span>:<span style=color:#e6db74>&#34;docker-io-mirror:5000&#34;</span>,<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;debug&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;resolving&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-07-02T04:08:17.778859386Z&#34;</span>}
</span></span><span style=display:flex><span>{<span style=color:#f92672>&#34;host&#34;</span>:<span style=color:#e6db74>&#34;docker-io-mirror:5000&#34;</span>,<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;debug&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;do request&#34;</span>,<span style=color:#f92672>&#34;request.header.accept&#34;</span>:<span style=color:#e6db74>&#34;application/vnd.docker.distribution.manifest.v2+json, application/vnd.docker.distribution.manifest.list.v2+json, application/vnd.oci.image.manifest.v1+json, application/vnd.oci.image.index.v1+json, */*&#34;</span>,<span style=color:#f92672>&#34;request.header.user-agent&#34;</span>:<span style=color:#e6db74>&#34;containerd/v1.6.19-k3s1&#34;</span>,<span style=color:#f92672>&#34;request.method&#34;</span>:<span style=color:#e6db74>&#34;HEAD&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-07-02T04:08:17.778877611Z&#34;</span>,<span style=color:#f92672>&#34;url&#34;</span>:<span style=color:#e6db74>&#34;http://docker-io-mirror:5000/v2/library/nginx/manifests/stable?ns=docker.io&#34;</span>}
</span></span></code></pre></div><p>Containerd pulls from the Registry Mirror!</p><p>Notice this time, we didn&rsquo;t need to specify the <strong>registry</strong> nor the <strong>repository</strong> explicitly. It did that transparently!</p><p>That&rsquo;s useful!</p><p>You don&rsquo;t wanna re-configure each image to come from your private OCI registry just to try the chart! That&rsquo;s toil!</p><p>If you configure a registry mirror, you don&rsquo;t have to!</p><p>Let&rsquo;s see if <code>nginx</code> is there in the docker-io-mirror&mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>docker exec k3d-dev-private-server-0 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  wget k3d-docker-io-mirror:5000/v2/_catalog -qO - | <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  jq
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;repositories&#34;</span>: [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;library/nginx&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;rancher/klipper-helm&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;rancher/klipper-lb&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;rancher/local-path-provisioner&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;rancher/mirrored-coredns-coredns&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;rancher/mirrored-library-traefik&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;rancher/mirrored-metrics-server&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;rancher/mirrored-pause&#34;</span>
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It is! Not only is nginx there, but all of the k3d images are there too!</p><p>They&rsquo;re cached in our private registry mirror.</p><p>That should make it faster to spin up more k3d clusters 😁 !</p><h2 id=lets-try-out-this-other-helm-chart>Let&rsquo;s Try Out This Other Helm Chart</h2><p>Now the container runtime uses our private resgitry proxies as a Registry Mirror for dockerhub and quayio.</p><p>If you&rsquo;re using helm charts, <code>cert-manager</code> is likely one of the leaves of your chart dependency tree.</p><p>Lets use <code>cert-manager</code> as an example&mldr;</p><h3 id=set-up-the-helm-repo>Set Up The Helm Repo</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>helm repo add cert-manager https://charts.jetstack.io
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#e6db74>&#34;cert-manager&#34;</span> has been added to your repositories
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>helm repo update cert-manager 
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>Hang tight <span style=color:#66d9ef>while</span> we grab the latest from your chart repositories...
</span></span><span style=display:flex><span>...Successfully got an update from the <span style=color:#e6db74>&#34;cert-manager&#34;</span> chart repository
</span></span><span style=display:flex><span>Update Complete. ⎈Happy Helming!⎈
</span></span></code></pre></div><h3 id=create-the-crds-in-the-cluster>Create The CRDs In The Cluster</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.12.3/cert-manager.crds.yaml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/certificaterequests.cert-manager.io created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/certificates.cert-manager.io created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/challenges.acme.cert-manager.io created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/clusterissuers.cert-manager.io created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/issuers.cert-manager.io created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/orders.acme.cert-manager.io created
</span></span></code></pre></div><h3 id=install-the-chart>Install The Chart</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>helm install cert-manager <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>cert-manager/cert-manager <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--version v1.12.3 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--debug
</span></span></code></pre></div><p>No need custom values files.</p><p>A moment later, its up and running!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl get po
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>NAME                                       READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>cert-manager-cainjector-69b9bf685d-z8czg   1/1     Running   <span style=color:#ae81ff>0</span>          50s
</span></span><span style=display:flex><span>cert-manager-697954868b-2p8bz              1/1     Running   <span style=color:#ae81ff>0</span>          50s
</span></span><span style=display:flex><span>cert-manager-startupapicheck-nvcgz         1/1     Running   <span style=color:#ae81ff>0</span>          49s
</span></span><span style=display:flex><span>cert-manager-webhook-59f46cd9c6-l585n      1/1     Running   <span style=color:#ae81ff>0</span>          50s
</span></span></code></pre></div><p>Containerd pulled the images from the mirror.</p><p>Let&rsquo;s inspect all image refs in the chart&rsquo;s default values:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>helm inspect values cert-manager/cert-manager | grep -i image: -A1
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>image</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>repository</span>: <span style=color:#ae81ff>quay.io/jetstack/cert-manager-controller</span>
</span></span><span style=display:flex><span>--
</span></span><span style=display:flex><span>  <span style=color:#f92672>image</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>repository</span>: <span style=color:#ae81ff>quay.io/jetstack/cert-manager-webhook</span>
</span></span><span style=display:flex><span>--
</span></span><span style=display:flex><span>  <span style=color:#f92672>image</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>repository</span>: <span style=color:#ae81ff>quay.io/jetstack/cert-manager-cainjector</span>
</span></span><span style=display:flex><span>--
</span></span><span style=display:flex><span>  <span style=color:#f92672>image</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>repository</span>: <span style=color:#ae81ff>quay.io/jetstack/cert-manager-acmesolver</span>
</span></span><span style=display:flex><span>--
</span></span><span style=display:flex><span>  <span style=color:#f92672>image</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>repository</span>: <span style=color:#ae81ff>quay.io/jetstack/cert-manager-ctl</span>
</span></span></code></pre></div><p>By default, cert-manager is pulling images from <code>quay.io</code>.</p><p>We didn&rsquo;t change anything. Helm just installed the Chart and pods started running exactly as you&rsquo;d expect. Exactly the same as if the cluster could pull from the public Internet.</p><h1 id=open-for-experimentation>Open For Experimentation</h1><p>Charts often have more than one container image. They may have one or more subcharts. They may package CRDs, which themselves reference container images.</p><p>The problem of discovering images required by a chart is acknowledged in the <a href=https://github.com/helm/community/blob/main/hips/hip-0015.md>Helm Improvement Proposal 0015</a>.</p><p>If we configure our private OCI registry as a Registry Mirror, Containerd resolves public images to our private registry. Next time we wanna experiment with a public helm chart on our cluster, devs don&rsquo;t need to change any image refs!</p><p>That&rsquo;s useful! An improvement in Usability.</p><p>Less friction for Aisha and platform engineers.</p><p>For Development and Test workflows, we wanna be <strong>open for experimentation</strong> so that we can get fast feedback on our ideas.</p><p>We can enable that, while still complying with standard registry policy, by configuring Registry Mirrors in the CRI.</p><hr><a rel=license href=https://creativecommons.org/licenses/by/4.0/><img alt="Creative Commons Licence" style=border-width:0 src=https://i.creativecommons.org/l/by/4.0/88x31.png></a><br>Except where otherwise noted, all original <span xmlns:dct=http://purl.org/dc/terms/ href=http://purl.org/dc/dcmitype/StillImage rel=dct:type>content</span> by
<a xmlns:cc=http://creativecommons.org/ns# href=https://www.douglashellinger.com/ property="cc:attributionName" rel=cc:attributionurl>Douglas Hellinger</a> is licensed under a
<a rel=license href=https://creativecommons.org/licenses/by/4.0/>Creative Commons Attribution 4.0 International
License</a>.</div><div class=after-post-tags><ul class=tags><li><a href=/tags/kubernetes>kubernetes</a></li><li><a href=/tags/oci>oci</a></li><li><a href=/tags/registry>registry</a></li><li><a href=/tags/runtime>runtime</a></li><li><a href=/tags/container>container'</a></li><li><a href=/tags/cri>cri</a></li><li><a href=/tags/distribution>distribution</a></li><li><a href=/tags/crd>CRD</a></li></ul></div><div class="row PageNavigation d-flex justify-content-between font-weight-bold"><a class="d-block col-md-6 text-lg-right" href=https://www.douglashellinger.com/explainer/container-oci-registry/pull-a-public-container-image/>Exploring OCI Container Registries: Chapter 1: Pull a Public Image from Kubernetes &#187;</a><div class=clearfix></div></div></div></div></div><div class=container><div id=comments class="row justify-content-center mb-5"><div class=col-md-8></div></div></div></div></div><div class="jumbotron fortags"><div class="d-md-flex h-100"><div class="col-md-4 transpdark align-self-center text-center h-100"><div class="d-md-flex align-items-center justify-content-center h-100"><h2 class="d-md-block d-none align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2></div></div><div class="col-md-8 p-5 align-self-center text-center"><a class="mt-1 mb-1" href=/tags/ai>ai</a>
<a class="mt-1 mb-1" href=/tags/build-pipeline>build-pipeline</a>
<a class="mt-1 mb-1" href=/tags/builder-image>builder-image</a>
<a class="mt-1 mb-1" href=/tags/chart>chart</a>
<a class="mt-1 mb-1" href=/tags/cloud>cloud</a>
<a class="mt-1 mb-1" href=/tags/container>container</a>
<a class="mt-1 mb-1" href=/tags/containers>containers</a>
<a class="mt-1 mb-1" href=/tags/copilot>copilot</a>
<a class="mt-1 mb-1" href=/tags/crd>crd</a>
<a class="mt-1 mb-1" href=/tags/cri>cri</a>
<a class="mt-1 mb-1" href=/tags/ctf>ctf</a>
<a class="mt-1 mb-1" href=/tags/cybersecurity>cybersecurity</a>
<a class="mt-1 mb-1" href=/tags/deployment>deployment</a>
<a class="mt-1 mb-1" href=/tags/distribution>distribution</a>
<a class="mt-1 mb-1" href=/tags/docs-as-code>docs-as-code</a>
<a class="mt-1 mb-1" href=/tags/driver>driver</a>
<a class="mt-1 mb-1" href=/tags/encryption>encryption</a>
<a class="mt-1 mb-1" href=/tags/food>food</a>
<a class="mt-1 mb-1" href=/tags/github>github</a>
<a class="mt-1 mb-1" href=/tags/gpg>gpg</a>
<a class="mt-1 mb-1" href=/tags/helm>helm</a>
<a class="mt-1 mb-1" href=/tags/kubernetes>kubernetes</a>
<a class="mt-1 mb-1" href=/tags/medium>medium</a>
<a class="mt-1 mb-1" href=/tags/oci>oci</a>
<a class="mt-1 mb-1" href=/tags/overthewire>overthewire</a>
<a class="mt-1 mb-1" href=/tags/pair-programming>pair-programming</a>
<a class="mt-1 mb-1" href=/tags/problem-solving>problem-solving</a>
<a class="mt-1 mb-1" href=/tags/programming>programming</a>
<a class="mt-1 mb-1" href=/tags/proxy>proxy</a>
<a class="mt-1 mb-1" href=/tags/registry>registry</a>
<a class="mt-1 mb-1" href=/tags/runtime>runtime</a>
<a class="mt-1 mb-1" href=/tags/security>security</a>
<a class="mt-1 mb-1" href=/tags/sigstore>sigstore</a>
<a class="mt-1 mb-1" href=/tags/stream-cipher>stream-cipher</a>
<a class="mt-1 mb-1" href=/tags/thinkpad>thinkpad</a>
<a class="mt-1 mb-1" href=/tags/troubleshooting>troubleshooting</a>
<a class="mt-1 mb-1" href=/tags/ubuntu>ubuntu</a>
<a class="mt-1 mb-1" href=/tags/verify>verify</a>
<a class="mt-1 mb-1" href=/tags/writing>writing</a></div></div></div><footer class=footer><div class=container><div class=row><div class="col-md-6 col-sm-6 text-center text-lg-left">&copy; Copyright Douglas Hellinger 2022 - Present</div><div class="col-md-6 col-sm-6 text-center text-lg-right"><a target=_blank rel=noopener href=https://www.wowthemes.net>Mediumish Theme</a> by WowThemes.net</div></div></div></footer></div><script src=https://code.jquery.com/jquery-3.4.1.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js integrity=sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut crossorigin=anonymous></script>
<script src=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js integrity=sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM crossorigin=anonymous></script>
<script src=https://www.douglashellinger.com/js/mediumish.84218587c174fd40bce82544b98851670f0b124a7324b349c54a4065e2b32ffc.js integrity="sha256-hCGFh8F0/UC86CVEuYhRZw8LEkpzJLNJxUpAZeKzL/w="></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TEH3VGXMRY"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-TEH3VGXMRY",{anonymize_ip:!1})}</script></body></html>